<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video MÉ™lumatÄ± Ã‡Ä±xarma QiymÉ™t PlanlarÄ± vÉ™ Simulyatoru</title>
    <!-- Tailwind CSS vÉ™ Inter ÅŸriftini yÃ¼klÉ™yin -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8faff;
        }
        .card-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .premium-button-1 {
            background-image: linear-gradient(to right, #4338ca, #6366f1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .premium-button-1:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(63, 94, 251, 0.5);
        }
        /* Gizli modalÄ± mÉ™rkÉ™zlÉ™ÅŸdirmÉ™k Ã¼Ã§Ã¼n stil */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }
        /* Ä°stifadÉ™Ã§ini mÃ¼É™yyÉ™nlÉ™ÅŸdirmÉ™k Ã¼Ã§Ã¼n rÉ™ng */
        #user-info-text {
            color: #4f46e5;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- BaÅŸlÄ±q vÉ™ Ä°stifadÉ™Ã§i MÉ™lumatÄ± -->
    <header class="w-full max-w-6xl flex justify-between items-center py-6 mb-8 border-b border-gray-200">
        <h1 class="text-3xl font-extrabold text-gray-900">
            AbunÉ™lik Simulyatoru <span class="text-indigo-600">v2.0</span>
        </h1>
        <div class="flex items-center space-x-4">
            <span id="user-info-text" class="text-lg font-semibold">GÃ¶zlÉ™yir...</span>
            <button id="auth-button" class="px-4 py-2 bg-indigo-500 text-white font-medium rounded-lg hover:bg-indigo-600 transition duration-150">
                GiriÅŸ / Qeydiyyat
            </button>
        </div>
    </header>

    <!-- Qeydiyyat/GiriÅŸ FormasÄ± (Auth Modal) -->
    <div id="auth-modal" class="hidden fixed inset-0 flex items-center justify-center modal-overlay">
        <div class="bg-white p-8 rounded-xl card-shadow w-full max-w-md mx-4">
            <h2 id="auth-title" class="text-3xl font-bold mb-6 text-center text-gray-800">Qeydiyyat</h2>
            <div id="auth-message" class="hidden p-3 mb-4 rounded-lg text-sm font-medium"></div>

            <input type="email" id="auth-email" placeholder="E-poÃ§t Ã¼nvanÄ±" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <input type="password" id="auth-password" placeholder="ÅifrÉ™" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            
            <button id="register-btn" class="w-full p-3 mb-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-150">Qeydiyyat</button>
            <button id="login-btn" class="w-full p-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition duration-150 hidden">Daxil Ol</button>

            <p class="mt-6 text-center text-sm text-gray-600">
                <a href="#" id="toggle-auth-mode" class="text-indigo-600 hover:text-indigo-800 font-medium">Daxil Olmaq istÉ™yirsiniz?</a>
            </p>
        </div>
    </div>


    <!-- Æsas Kontent (YalnÄ±z Daxil Olan Ä°stifadÉ™Ã§ilÉ™r ÃœÃ§Ã¼n) -->
    <main id="main-content" class="w-full max-w-6xl hidden">
        <div id="subscribe-message" class="hidden p-4 mb-6 rounded-lg text-sm font-medium"></div>

        <!-- QiymÉ™t PlanlarÄ± KartlarÄ± -->
        <div class="grid md:grid-cols-3 gap-8">

            <!-- 1. Pulsuz Plan (Free) -->
            <div id="card-free" class="bg-white p-8 rounded-xl card-shadow flex flex-col border-2 border-indigo-100 transition duration-300 hover:border-indigo-300">
                <div class="flex-grow">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Pulsuz Plan</h2>
                    <p class="text-gray-500 mb-6">MÉ™hsulu sÄ±naqdan keÃ§irmÉ™k Ã¼Ã§Ã¼n É™la</p>

                    <p class="text-4xl font-extrabold text-gray-900 mb-6">
                        $0 <span class="text-lg font-medium text-gray-500">/ ay</span>
                    </p>

                    <ul class="space-y-3 text-gray-600 mb-8">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-indigo-500 mr-3 mt-1"></i>
                            <span class="font-medium">50 Video MÉ™lumat Ã‡Ä±xarÄ±lmasÄ±</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-indigo-500 mr-3 mt-1"></i>
                            <span>Æsas Analitika</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-times-circle text-gray-400 mr-3 mt-1"></i>
                            <span class="text-gray-400 line-through">Prioritet DÉ™stÉ™k</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-times-circle text-gray-400 mr-3 mt-1"></i>
                            <span class="text-gray-400 line-through">GeniÅŸlÉ™ndirilmiÅŸ API GiriÅŸi</span>
                        </li>
                    </ul>
                </div>

                <button id="subscribe-free" data-plan="Free" class="w-full py-3 mt-auto bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 transition duration-150 subscribe-btn" disabled>
                    Cari PlanÄ±nÄ±z
                </button>
            </div>

            <!-- 2. Premium Plan (Premium 1) -->
            <div id="card-premium1" class="bg-white p-8 rounded-xl card-shadow flex flex-col border-2 border-indigo-100 transition duration-300 hover:border-indigo-300 relative">
                <span class="absolute top-0 right-0 -mt-3 -mr-3 px-4 py-1 bg-yellow-500 text-white text-xs font-bold uppercase rounded-full shadow-lg hidden">ÆN POPULYAR</span>
                <div class="flex-grow">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Premium 1 PlanÄ±</h2>
                    <p class="text-gray-500 mb-6">FÉ™rdi istifadÉ™Ã§ilÉ™r vÉ™ kiÃ§ik komandalar Ã¼Ã§Ã¼n</p>

                    <p class="text-4xl font-extrabold text-gray-900 mb-6">
                        $29 <span class="text-lg font-medium text-gray-500">/ ay</span>
                    </p>

                    <ul class="space-y-3 text-gray-600 mb-8">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-indigo-500 mr-3 mt-1"></i>
                            <span class="font-medium">1000 Video MÉ™lumat Ã‡Ä±xarÄ±lmasÄ±</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-indigo-500 mr-3 mt-1"></i>
                            <span>GeniÅŸlÉ™ndirilmiÅŸ Analitika</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-indigo-500 mr-3 mt-1"></i>
                            <span>Prioritet E-poÃ§t DÉ™stÉ™yi</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-times-circle text-gray-400 mr-3 mt-1"></i>
                            <span class="text-gray-400 line-through">GeniÅŸlÉ™ndirilmiÅŸ API GiriÅŸi</span>
                        </li>
                    </ul>
                </div>

                <button id="subscribe-premium1" data-plan="Premium 1" class="w-full py-3 mt-auto text-white font-bold rounded-lg premium-button-1 subscribe-btn">
                    AbunÉ™ Ol
                </button>
            </div>

            <!-- 3. Premium Plan (Premium 2) -->
            <div id="card-premium2" class="bg-white p-8 rounded-xl card-shadow flex flex-col border-2 border-indigo-100 transition duration-300 hover:border-indigo-300">
                <div class="flex-grow">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Premium 2 PlanÄ±</h2>
                    <p class="text-gray-500 mb-6">BÃ¶yÃ¼k komandalar vÉ™ mÃ¼É™ssisÉ™lÉ™r Ã¼Ã§Ã¼n</p>

                    <p class="text-4xl font-extrabold text-gray-900 mb-6">
                        $99 <span class="text-lg font-medium text-gray-500">/ ay</span>
                    </p>

                    <ul class="space-y-3 text-gray-600 mb-8">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-indigo-500 mr-3 mt-1"></i>
                            <span class="font-medium">Limitsiz Video MÉ™lumat Ã‡Ä±xarÄ±lmasÄ±</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-indigo-500 mr-3 mt-1"></i>
                            <span>ÆtraflÄ± Analitika vÉ™ Hesabatlar</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-indigo-500 mr-3 mt-1"></i>
                            <span>24/7 XÃ¼susi DÉ™stÉ™k</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-indigo-500 mr-3 mt-1"></i>
                            <span class="font-medium">GeniÅŸlÉ™ndirilmiÅŸ API GiriÅŸi</span>
                        </li>
                    </ul>
                </div>

                <button id="subscribe-premium2" data-plan="Premium 2" class="w-full py-3 mt-auto bg-gray-100 text-indigo-600 font-bold rounded-lg hover:bg-indigo-50 transition duration-150 subscribe-btn">
                    AbunÉ™ Ol
                </button>
            </div>

        </div>
    </main>

    <!-- Firebase vÉ™ Æsas JavaScript MÉ™ntiqi -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestore loqlarÄ±nÄ± yandÄ±rmaq
        setLogLevel('Debug');

        // Global Firebase dÉ™yiÅŸÉ™nlÉ™ri
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db;
        let unsubscribeFromPlan = null;
        let currentUserId = null;
        let currentUserEmail = null;

        // UI ElementlÉ™ri
        const userInfoEl = document.getElementById('user-info-text');
        const authButton = document.getElementById('auth-button');
        const mainContentEl = document.getElementById('main-content');
        const subscribeMessageEl = document.getElementById('subscribe-message');
        const authModal = document.getElementById('auth-modal');
        const authTitle = document.getElementById('auth-title');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const registerBtn = document.getElementById('register-btn');
        const loginBtn = document.getElementById('login-btn');
        const toggleAuthMode = document.getElementById('toggle-auth-mode');
        const authMessageEl = document.getElementById('auth-message');

        // Auth rejimi
        let isRegisterMode = true;

        // Simulyasiya Ã¼Ã§Ã¼n API endpoint (hÉ™qiqi deyil)
        const API_URL = 'https://api.mockservice.com/v1';

        // XÉ™bÉ™rdarlÄ±q/Mesaj gÃ¶stÉ™rmÉ™k Ã¼Ã§Ã¼n kÃ¶mÉ™kÃ§i funksiya
        function displayMessage(element, message, isError) {
            element.textContent = message;
            element.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (isError) {
                element.classList.add('bg-red-100', 'text-red-700');
            } else {
                element.classList.add('bg-green-100', 'text-green-700');
            }
            // Avtomatik olaraq mesajÄ± tÉ™mizlÉ™
            setTimeout(() => {
                 element.classList.add('hidden');
                 element.textContent = '';
            }, 5000);
        }

        // UI-Ä± mÃ¶vcud abunÉ™lik vÉ™ziyyÉ™tinÉ™ gÃ¶rÉ™ yenilÉ™yir
        function updateUI(email, currentPlanName) {
            
            // Ä°stifadÉ™Ã§i mÉ™lumatÄ±nÄ± yenilÉ™
            currentUserEmail = email;
            userInfoEl.textContent = `${email}`;
            
            // AbunÉ™lik mÉ™lumatÄ±na gÃ¶rÉ™ kartlarÄ± yenilÉ™
            const plans = [
                { id: 'card-free', btnId: 'subscribe-free', name: 'Free' },
                { id: 'card-premium1', btnId: 'subscribe-premium1', name: 'Premium 1' },
                { id: 'card-premium2', btnId: 'subscribe-premium2', name: 'Premium 2' }
            ];

            plans.forEach(plan => {
                const cardEl = document.getElementById(plan.id);
                const btnEl = document.getElementById(plan.btnId);

                // Kart stilini tÉ™mizlÉ™
                cardEl.classList.remove('border-indigo-600', 'border-indigo-800');
                cardEl.classList.add('border-indigo-100', 'hover:border-indigo-300');
                
                // DÃ¼ymÉ™ni sÄ±fÄ±rla
                btnEl.textContent = 'AbunÉ™ Ol';
                btnEl.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'premium-button-1', 'bg-gray-100', 'text-indigo-600', 'hover:bg-indigo-50', 'bg-red-500', 'text-white', 'hover:bg-red-600');
                btnEl.classList.add('bg-gray-100', 'text-indigo-600', 'hover:bg-indigo-50');
                btnEl.disabled = false;

                if (plan.name === currentPlanName) {
                    // Cari Plan
                    cardEl.classList.add('border-indigo-600');
                    cardEl.classList.remove('border-indigo-100', 'hover:border-indigo-300');
                    btnEl.textContent = 'Cari PlanÄ±nÄ±z';
                    btnEl.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    btnEl.classList.remove('bg-gray-100', 'text-indigo-600', 'hover:bg-indigo-50');
                    btnEl.disabled = true;

                    // Pulsuz plandan Ã§Ä±xmaq Ã¼Ã§Ã¼n (yÉ™ni, abunÉ™likdÉ™n imtina)
                    if (currentPlanName !== 'Free') {
                         btnEl.textContent = 'AbunÉ™likdÉ™n Ä°mtina Et';
                         btnEl.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                         btnEl.classList.add('bg-red-500', 'text-white', 'hover:bg-red-600');
                         btnEl.disabled = false;
                    }
                } else if (currentPlanName === 'Free' && plan.name.startsWith('Premium')) {
                    // Pulsuz plandan upgrade
                    btnEl.textContent = 'Upgrade et';
                    btnEl.classList.add('premium-button-1');
                    btnEl.classList.remove('bg-gray-100', 'text-indigo-600', 'hover:bg-indigo-50');
                } else if (plan.name.startsWith('Premium') && currentPlanName.startsWith('Premium')) {
                    // Premiumlar arasÄ±nda keÃ§id (Upgrade/Downgrade)
                    if (plan.name === 'Premium 1' && currentPlanName === 'Premium 2') {
                        btnEl.textContent = 'Downgrade et';
                        btnEl.classList.add('bg-red-500', 'text-white', 'hover:bg-red-600');
                        btnEl.classList.remove('bg-gray-100', 'text-indigo-600', 'hover:bg-indigo-50');
                    } else if (plan.name === 'Premium 2' && currentPlanName === 'Premium 1') {
                        btnEl.textContent = 'Upgrade et';
                        btnEl.classList.add('premium-button-1');
                        btnEl.classList.remove('bg-gray-100', 'text-indigo-600', 'hover:bg-indigo-50');
                    }
                }
            });

            // Pulsuz plan dÃ¼ymÉ™sinin vÉ™ziyyÉ™ti
            const freeBtn = document.getElementById('subscribe-free');
            if (currentPlanName === 'Free') {
                freeBtn.disabled = true;
            } else if (currentPlanName === 'Premium 1' || currentPlanName === 'Premium 2') {
                 // AbunÉ™likdÉ™n imtina et dÃ¼ymÉ™sini qÄ±rmÄ±zÄ± et
                const currentPlanBtn = document.getElementById('subscribe-' + currentPlanName.toLowerCase().replace(' ', ''));
                currentPlanBtn.textContent = 'AbunÉ™likdÉ™n Ä°mtina Et';
                currentPlanBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                currentPlanBtn.classList.add('bg-red-500', 'text-white', 'hover:bg-red-600');
                currentPlanBtn.disabled = false; // Ä°mtina etmÉ™yi aktiv saxla
            }
        }

        // Firestore AbunÉ™lik MÉ™lumatlarÄ±nÄ± Yadda Saxla
        async function saveUserSubscription(planName) {
            if (!db || !currentUserId) return;
            // UnutmayÄ±n: bÃ¼tÃ¼n mÉ™lumatlar /artifacts/{appId}/users/{userId}/subscriptions/userSubscription yolu Ã¼zÉ™rindÉ™dir.
            const planRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'subscriptions', 'userSubscription');
            
            try {
                await setDoc(planRef, {
                    plan: planName,
                    updatedAt: new Date().toISOString()
                }, { merge: true });
            } catch (error) {
                console.error("Firestore-a abunÉ™lik mÉ™lumatlarÄ±nÄ± yazarkÉ™n xÉ™ta baÅŸ verdi:", error);
                displayMessage(subscribeMessageEl, `âŒ AbunÉ™lik SaxlanmasÄ± XÉ™tasÄ±: ${error.message}`, true);
            }
        }
        
        // Firestore AbunÉ™lik MÉ™lumatlarÄ±nÄ± DinlÉ™
        function subscribeToPlanChanges(userId) {
            if (unsubscribeFromPlan) {
                unsubscribeFromPlan(); // ÆvvÉ™lki dinlÉ™yicini dayandÄ±r
            }
            if (!db || !userId) return;

            const planRef = doc(db, 'artifacts', appId, 'users', userId, 'subscriptions', 'userSubscription');

            unsubscribeFromPlan = onSnapshot(planRef, (docSnap) => {
                let currentPlan = 'Free'; // VarsayÄ±lan olaraq Pulsuz

                if (docSnap.exists()) {
                    currentPlan = docSnap.data().plan || 'Free';
                }
                
                // UI-Ä± yeni planla yenilÉ™
                updateUI(currentUserEmail, currentPlan);

            }, (error) => {
                console.error("AbunÉ™lik dÉ™yiÅŸikliklÉ™rini dinlÉ™yÉ™rkÉ™n xÉ™ta baÅŸ verdi:", error);
                displayMessage(subscribeMessageEl, `âŒ AbunÉ™lik mÉ™lumatlarÄ±nÄ± yÃ¼klÉ™yÉ™rkÉ™n xÉ™ta: ${error.message}`, true);
            });
        }
        
        // AbunÉ™lik DÃ¼ymÉ™sinin Ä°darÉ™ EdilmÉ™si
        async function handleSubscribeClick(event) {
            const btn = event.target;
            const planName = btn.dataset.plan;
            
            if (btn.disabled || !currentUserId || currentUserEmail.startsWith('Anonim')) {
                // ÆgÉ™r anonim vÉ™ ya daxil olmayÄ±bsa, modalÄ± aÃ§
                toggleAuthModal(true);
                displayMessage(subscribeMessageEl, "AbunÉ™ olmaq Ã¼Ã§Ã¼n daxil olmalÄ± vÉ™ ya qeydiyyatdan keÃ§mÉ™lisiniz.", true);
                return;
            }

            const subscribeMessageEl = document.getElementById('subscribe-message');
            subscribeMessageEl.classList.add('hidden'); // ÆvvÉ™lki mesajÄ± gizlÉ™t

            try {
                let currentPlan = planName;
                let message = `Siz indi "${planName}" planÄ±na abunÉ™siniz. TÉ™ÅŸÉ™kkÃ¼r edirik!`;

                // AbunÉ™likdÉ™n imtina etmÉ™k (Free plana keÃ§mÉ™k)
                if (btn.textContent.includes('AbunÉ™likdÉ™n Ä°mtina Et')) {
                    currentPlan = 'Free';
                    message = `Siz ${currentUserEmail} Ã¼Ã§Ã¼n abunÉ™likdÉ™n uÄŸurla imtina etdiniz. Cari planÄ±nÄ±z: Pulsuz.`;
                    
                    // HÉ™qiqi API Ã§aÄŸÄ±rÄ±ÅŸÄ± burada olmalÄ±dÄ±r: fetch(`${API_URL}/unsubscribe`, { ... });
                } else {
                    // Ã–dÉ™niÅŸli plana abunÉ™lik simulyasiyasÄ± (Upgrade/Downgrade)
                    
                    // HÉ™qiqi API Ã§aÄŸÄ±rÄ±ÅŸÄ± burada olmalÄ±dÄ±r
                }

                // Firestore-u yenilÉ™ (bu, onSnapshot vasitÉ™silÉ™ UI-Ä± avtomatik yenilÉ™yÉ™cÉ™k)
                await saveUserSubscription(currentPlan);

                displayMessage(subscribeMessageEl, message, false);

            } catch (error) {
                displayMessage(subscribeMessageEl, `âŒ XÉ™ta: ${error.message}`, true);
            }
        }

        // Qeydiyyat/GiriÅŸ ModalÄ±nÄ± AÃ§/BaÄŸla
        function toggleAuthModal(show) {
            if (show) {
                authModal.classList.remove('hidden');
                // ModalÄ± aÃ§arkÉ™n daxil etmÉ™ sahÉ™lÉ™rini tÉ™mizlÉ™
                authEmailInput.value = '';
                authPasswordInput.value = '';
                authMessageEl.classList.add('hidden');
                // Rejimi yenidÉ™n tÉ™yin et
                setAuthModeUI(isRegisterMode); 
            } else {
                authModal.classList.add('hidden');
            }
        }
        
        // Qeydiyyat/GiriÅŸ rejiminin UI-Ä±nÄ± tÉ™yin et
        function setAuthModeUI(isRegister) {
            authTitle.textContent = isRegister ? 'Qeydiyyat' : 'Daxil Ol';
            registerBtn.classList.toggle('hidden', !isRegister);
            loginBtn.classList.toggle('hidden', isRegister);
            toggleAuthMode.textContent = isRegister ? 'Daxil Olmaq istÉ™yirsiniz?' : 'Qeydiyyatdan keÃ§mÉ™k istÉ™yirsiniz?';
            authMessageEl.classList.add('hidden'); // MesajÄ± tÉ™mizlÉ™
        }

        // Qeydiyyat
        async function handleRegister() {
            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value.trim();
            
            if (!email || !password) {
                displayMessage(authMessageEl, "E-poÃ§t vÉ™ ÅŸifrÉ™ daxil edin.", true);
                return;
            }

            try {
                // ÅifrÉ™nin minimum uzunluÄŸunu yoxla (Firebase default 6-dÄ±r)
                 if (password.length < 6) {
                    throw new Error("auth/weak-password");
                }

                await createUserWithEmailAndPassword(auth, email, password);
                // Qeydiyyat uÄŸurlu olduqda, onAuthStateChanged iÅŸÉ™ dÃ¼ÅŸÉ™cÉ™k vÉ™ UI yenilÉ™nÉ™cÉ™k
                toggleAuthModal(false); 
                displayMessage(subscribeMessageEl, `âœ… UÄŸurla qeydiyyatdan keÃ§diniz: ${email}`, false);
            } catch (error) {
                console.error("Qeydiyyat xÉ™tasÄ±:", error);
                
                let errorMessage;
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Bu e-poÃ§t artÄ±q qeydiyyatdan keÃ§ib. Daxil olun.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'ÅifrÉ™ Ã§ox zÉ™ifdir. Æn azÄ± 6 simvol istifadÉ™ edin.';
                } else {
                    errorMessage = `âŒ XÉ™ta: ${error.message}`;
                }
                displayMessage(authMessageEl, errorMessage, true);
            }
        }

        // Daxil Olma
        async function handleLogin() {
            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value.trim();
            
            if (!email || !password) {
                displayMessage(authMessageEl, "E-poÃ§t vÉ™ ÅŸifrÉ™ daxil edin.", true);
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // GiriÅŸ uÄŸurlu olduqda, onAuthStateChanged iÅŸÉ™ dÃ¼ÅŸÉ™cÉ™k vÉ™ UI yenilÉ™nÉ™cÉ™k
                toggleAuthModal(false); 
                displayMessage(subscribeMessageEl, `âœ… UÄŸurla daxil oldunuz: ${email}`, false);
            } catch (error) {
                console.error("GiriÅŸ xÉ™tasÄ±:", error);
                
                let errorMessage;
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    errorMessage = 'YanlÄ±ÅŸ e-poÃ§t vÉ™ ya ÅŸifrÉ™.';
                } else {
                    errorMessage = `âŒ XÉ™ta: ${error.message}`;
                }
                displayMessage(authMessageEl, errorMessage, true);
            }
        }

        /**
         * Firebase-dÉ™n Ã§Ä±xÄ±ÅŸ funksiyasÄ±.
         * Ä°stifadÉ™Ã§inin hesabÄ± baÄŸlamasÄ±nÄ± vÉ™ onAuthStateChanged vasitÉ™silÉ™ UI-Ä±n yenilÉ™nmÉ™sini tÉ™min edir.
         */
        async function handleLogout() {
            try {
                const userEmail = currentUserEmail; // Ã‡Ä±xÄ±ÅŸdan É™vvÉ™l e-poÃ§tu saxla
                await signOut(auth);
                // Ã‡Ä±xÄ±ÅŸdan sonra UI onAuthStateChanged tÉ™rÉ™findÉ™n anonim istifadÉ™Ã§i vÉ™ziyyÉ™tinÉ™ keÃ§irilÉ™cÉ™k.
                
                // UÄŸurlu Ã§Ä±xÄ±ÅŸ mesajÄ±
                displayMessage(subscribeMessageEl, `ğŸ‘‹ ${userEmail} hesabÄ±ndan uÄŸurla Ã§Ä±xÄ±ÅŸ edildi.`, false); 
            } catch (error) {
                console.error("Ã‡Ä±xÄ±ÅŸ xÉ™tasÄ±:", error);
                displayMessage(subscribeMessageEl, `âŒ Ã‡Ä±xÄ±ÅŸ xÉ™tasÄ±: ${error.message}`, true);
            }
        }

        // BaÅŸlanÄŸÄ±cda token varsa, daxil ol
        const handleInitialAuth = async () => {
             // Ä°stifadÉ™Ã§i artÄ±q autentifikasiya olunubsa heÃ§ nÉ™ etmÉ™
             if (auth.currentUser) return; 

             if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("XÃ¼susi Token ilÉ™ GiriÅŸ XÉ™tasÄ± (Fallback to Anonymous):", error);
                    // Token uÄŸursuz olarsa, anonim daxil ol
                    await signInAnonymously(auth);
                }
             } else {
                 // Anonim daxil olmaq Ã¼Ã§Ã¼n (token yoxdursa)
                 await signInAnonymously(auth);
             }
        };

        // Firebase tÉ™tbiqini baÅŸladÄ±n
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // BaÅŸlanÄŸÄ±c Autentifikasiya vÉ™ziyyÉ™tini yoxla
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    // Anonim istifadÉ™Ã§idirsÉ™, "Anonim Ä°stifadÉ™Ã§i" olaraq gÃ¶stÉ™r
                    const email = user.email || (user.isAnonymous ? `Anonim (${user.uid.substring(0, 8)}...)` : 'Anonim Ä°stifadÉ™Ã§i'); 
                    currentUserEmail = email;

                    // UI-Ä± yenilÉ™
                    userInfoEl.textContent = `Ä°stifadÉ™Ã§i: ${currentUserEmail}`;
                    
                    // ÆgÉ™r e-poÃ§tla daxil olubsa, Ã§Ä±xÄ±ÅŸ dÃ¼ymÉ™sini gÃ¶stÉ™r, É™ks halda modalÄ± aÃ§maÄŸÄ± tÉ™klif et
                    if (user.email) {
                        authButton.textContent = 'Ã‡Ä±xÄ±ÅŸ';
                        authButton.onclick = handleLogout; // Ã‡Ä±xÄ±ÅŸ funksiyasÄ±nÄ± tÉ™yin et
                    } else {
                        // Anonim istifadÉ™Ã§idirsÉ™, "GiriÅŸ / Qeydiyyat" dÃ¼ymÉ™sini saxla
                        authButton.textContent = 'GiriÅŸ / Qeydiyyat';
                        authButton.onclick = null; // addEventListener-É™ etibar et
                    }

                    mainContentEl.classList.remove('hidden');
                    
                    // onAuthStateChanged tetiklÉ™ndikdÉ™ modalÄ±n aÃ§Ä±q qalmamasÄ± Ã¼Ã§Ã¼n
                    toggleAuthModal(false);

                    // AbunÉ™lik mÉ™lumatlarÄ±nÄ± dinlÉ™mÉ™yÉ™ baÅŸla
                    subscribeToPlanChanges(currentUserId);
                    
                    // ÆgÉ™r qeydiyyatdan keÃ§miÅŸ istifadÉ™Ã§idirsÉ™ VÆ abunÉ™lik planÄ± yoxdursa, Free planÄ±nÄ± Firestore-a yaz
                    if (user.email) {
                        const planRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'subscriptions', 'userSubscription');
                        const docSnap = await getDoc(planRef);
                        
                        // YalnÄ±z doc yoxdursa "Free" planÄ± tÉ™yin et
                        if (!docSnap.exists() || !docSnap.data()?.plan) {
                            await saveUserSubscription('Free');
                        }
                    }
                    
                } else {
                    // Ä°stifadÉ™Ã§i Ã§Ä±xÄ±b (null vÉ™ziyyÉ™ti, anonim daxil olmaÄŸa keÃ§É™cÉ™k)
                    currentUserId = null;
                    currentUserEmail = null;
                    userInfoEl.textContent = 'Daxil OlmayÄ±b';
                    authButton.textContent = 'GiriÅŸ / Qeydiyyat';
                    authButton.onclick = null; // TÉ™mizlÉ™
                    mainContentEl.classList.add('hidden');
                    if (unsubscribeFromPlan) unsubscribeFromPlan(); // DinlÉ™yicini dayandÄ±r
                    updateUI('Daxil OlmayÄ±b', 'Free'); // KartlarÄ± Pulsuz plan Ã¼Ã§Ã¼n yenilÉ™
                }
            });
            
            // onAuthStateChanged quraÅŸdÄ±rÄ±ldÄ±qdan dÉ™rhal sonra ilkin autentifikasiyanÄ± iÅŸÉ™ sal
            handleInitialAuth().catch(e => console.error("Æsas autentifikasiya xÉ™tasÄ±:", e));


        } else {
            console.error("Firebase konfiqurasiyasÄ± yoxdur. TÉ™tbiq iÅŸlÉ™mÉ™yÉ™cÉ™k.");
            userInfoEl.textContent = 'XÆTA: Firebase yÃ¼klÉ™nmÉ™di';
            authButton.disabled = true;
        }
        
        // --- Event DinlÉ™yicilÉ™ri ---
        
        // Auth dÃ¼ymÉ™sinin klik hadisÉ™sini burada É™lavÉ™ edirik ki, hÉ™miÅŸÉ™ iÅŸlÉ™sin (xÃ¼susÉ™n dÉ™ 'GiriÅŸ / Qeydiyyat' rejimindÉ™)
        authButton.addEventListener('click', () => {
            // ÆgÉ™r authButton.onclick artÄ±q 'handleLogout' olaraq tÉ™yin edilibsÉ™, heÃ§ nÉ™ etmÉ™,
            // É™ks halda modalÄ± aÃ§
            if (authButton.textContent.includes('GiriÅŸ') || authButton.textContent.includes('Qeydiyyat')) {
                 toggleAuthModal(true);
            }
        });


        // AbunÉ™lik dÃ¼ymÉ™lÉ™rini qoÅŸun
        document.querySelectorAll('.subscribe-btn').forEach(button => {
            button.addEventListener('click', handleSubscribeClick);
        });

        // Auth Modal dÃ¼ymÉ™lÉ™ri
        toggleAuthMode.addEventListener('click', (e) => {
            e.preventDefault();
            isRegisterMode = !isRegisterMode;
            setAuthModeUI(isRegisterMode);
            authMessageEl.classList.add('hidden'); // Rejim dÉ™yiÅŸÉ™ndÉ™ mesajÄ± tÉ™mizlÉ™
        });

        registerBtn.addEventListener('click', handleRegister);
        loginBtn.addEventListener('click', handleLogin);
        // ModalÄ± overlay-a kliklÉ™mÉ™klÉ™ baÄŸlamaq (yalnÄ±z daxil olmayan istifadÉ™Ã§ilÉ™r Ã¼Ã§Ã¼n)
        authModal.addEventListener('click', (e) => {
             // Ä°stifadÉ™Ã§i daxil olmayÄ±bsa VÆ klik overlay-a olubsa baÄŸla
             if (e.target === authModal && (!auth.currentUser || auth.currentUser.isAnonymous)) {
                 toggleAuthModal(false);
             }
        });
        
    </script>
</body>
</html>
